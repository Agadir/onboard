<% require 'onboard/network/routing' %>

<% all_tables = OnBoard::Network::Routing::Table.getAllIDs %>
<% all_interfaces = OnBoard::Network::Interface.getAll %>
<% all_rules = objects %>

<h2>Advanced Routing: Rules</h2>

<table>
  <thead>
    <tr>
      <th>Priority</th>
      <th>Source address/network</th>
      <th>Input Interface</th>
      <th>Output Interface</th>
      <th>Routing Table</th>
    </tr>
  </thead>
  <tbody>
    <% all_rules.each do |rule| %>
      <tr>
        <td><input class="rwtext" name="rule[][prio]" size="6" style="text-align: right;" value="<%= rule.prio %>"/></td>
        <td><input class="rwtext" name="rule[][from]" value="<%= rule.from %>"/></td>
        <!-- 
          "iif" and "oif" recall ip rule keywords, but really the process goes
          via iptables mark. Why don't use iproute2 directly? Because iptables
          allow you even to distinguish between different ports inside a 
          bridge ( iptables -m physdev ) which is a really intersting feature.
        -->        
        <% %w{rule[][iif] rule[][oif]}.each do |select_name| %>
          <td>
            <select name="<%= select_name %>">
              <option value=""></option>
              <% all_interfaces.each do |iface| %>
                <%
                  str = ""
                  str = "(bridge)" if iface.bridge?
                  str = "(bridge port)" if iface.bridged?
                  optional_bridge_info_str = str
                %>
                <option value="<%= iface.name %>"><%= iface.name %> <%= optional_bridge_info_str %></option>
              <% end %>
            </select>
          </td>
        <% end %>
        <td>
          <select class="tt" name="rule[][table]">
            <optgroup label="System Tables">
              <% all_tables['system_tables'].each_pair do |n, tbl| %>
                <option class="tt" value="<%= n %>" <%= 'selected' if [n.to_s, tbl.to_s].include? rule.table.to_s %>><%= sprintf("%3d", n).gsub(' ', '&nbsp;') %>: <%= tbl %></option>
              <% end %>
            </optgroup>
            <optgroup label="Custom Tables">
              <% all_tables['custom_tables'].each_pair do |n, tbl| %>
                <option class="tt" value="<%= n %>" <%= 'selected' if [n.to_s, tbl.to_s].include? rule.table.to_s %> ><%= sprintf("%3d", n).gsub(' ', '&nbsp;') %>: <%= tbl %></option>
              <% end %>           
            </optgroup>  
          </select>
        </td>
      </tr>
    <% end %>
  </tbody>
</table>

