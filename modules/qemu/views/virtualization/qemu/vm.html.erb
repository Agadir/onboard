<%
  require 'onboard/network/interface'
  require 'onboard/network/bridge'

  require 'onboard/virtualization/qemu'

  vm                  = objects[:vm] 

  all_netifs          = OnBoard::Network::Interface.get_all
  all_bridges         = all_netifs.select     { |i| i.bridge? }  
  all_running_ifnames = all_netifs.map        { |i| i.name    }        

  vnc_uri             = ( 
      "vnc://#{request.host}#{vm.config['-vnc']}" if vm.config['-vnc'] =~ /\d/ )
%>

<%= 
  partial(
    :module => 'qemu',
    :path   => 'virtualization/qemu/_style'
  )
%>

<%= 
  partial(
    :module => 'qemu',
    :path   => 'virtualization/qemu/_js',
  )
%>

<%= message_partial(msg) %>

<h2>QEMU Virtual Machine: &ldquo;<%= vm.config['-name'] %>&rdquo;</h2>

<% if vm.running? %>
  <% screenshot_path = "#{vm.uuid_short}/screen.png" %>
  <a title="Click for full-size screenshot" class="img" href="<%= screenshot_path %>"><img src="<%= screenshot_path %>" style="width:30em"/></a>
  <% if vnc_uri %>
    <p class="optinfo" style="font-size:100%;">
      VNC available at <a href="<%= vnc_uri %>"><%= vnc_uri %></a>
    </p>
  <% end %>
<% end %>

<form method="POST">
  <input type="hidden" name="_method" value="put"/>
    <%= 
      partial(
        :module => 'qemu',
        :path   => 'virtualization/qemu/vm/_run',
        :locals => {:vm => vm} 
      )
    %>
</form>

<h3>Snapshots</h3>
<table>
  <thead>
    <tr>
      <th>Drive</th>
      <th>Snapshot ID</th>
      <th>Tag / Name</th>
      <th>Type</th>
      <th>Date / Time</th>
      <!-- VM Clock ? -->
    </tr>
  </thead>
  <tbody>
    <% 
      drives_w_snapshots = vm.drives.select do |k,v| 
        v['snapshots'] and v['snapshots'].any?
      end
      drives_w_snapshots.each_pair do |drive_name, drive| 
    %>
      <% drive['snapshots'].each do |snapshot| %>
        <tr>
          <td><%= drive_name %></td>
          <td style="text-align:right;"><%= snapshot.id %></td>
          <td><%= snapshot.tag %></td>
          <td>
            <%= 
              if snapshot.vmsize == '0'
                'Disk Only'
              else
                "VM, size=#{snapshot.vmsize}"
              end
            %>
          </td>
          <td><%= snapshot.time %></td>
        </tr>
      <% end %>
    <% end %>
  </tbody>
</table>

<h3>Static Configuration</h3>

<div class="warn" style="margin-bottom:4.3ex; margin-top: 0;">
  Changes will take effect the next time you start the VM.
</div>

<form method="POST">
  <input type="hidden" name="_method" value="put"/>
  <%= 
    partial(
      :module => 'qemu',
      :path   => 'virtualization/qemu/_form_create_edit',
      :locals => {
        :all_bridges        => all_bridges,
        :vm                 => vm
      }
    )
  %>

  <button style="margin-top:3.3ex;" type="submit">Change!</button>
</form>

<script type="text/javascript">
  <%# js functions implemented in qemu/_js.html.erb %>
  qemuSaveRestoreControls('<%= vm.uuid %>');
  qemuNetIfControls();
</script>
