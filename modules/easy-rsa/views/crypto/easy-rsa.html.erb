<% 
  require 'i18n_data' 
  require 'date'
%>

<h2>SSL keys and certificates</h2>
<h3>Diffie-Hellman parameters</h3>
<table>
  <thead>
    <tr>
      <th>File name</th>
      <th>Size</th>
      <th>Status</th>
    </tr>
  </thead>
  <tbody>
    <% objects['dh'].each_pair do |filename, dh_h| %>   
      <tr> 
        <td><code><%= filename %></code></td>
        <td><%= dh_h['size'] %></td>
        <td>
          <%= 
            if not dh_h['err']
              'Ok'  
            elsif dh_h['being_created'] 
              '<span style="font-style:italic;">generating DH params... this may take a long time...</span>'
            else
              dh_h['err']
            end
          %>
        </td>
      </tr>
    <% end %>
  </tbody>
</table>
<h3>Certificates</h3>
<table>
  <thead><tr>
    <th>Delete?</th>
    <th>&ldquo;Common Name&rdquo;</th>
    <th>Issued by:</th>
    <th>Issued to:</th>
    <th>Key size (bits)</th>
    <th>Private Key?</th>
    <th>Cert. Authority?</th> 
    <th>Server?</th>
  </tr></thead>
  <tbody>
    <% objects['certs'].each_pair do |name, cert| %>
      <tr>
        <td style="text-align: center;">
          <form method="POST" action="/crypto/ssl/certs/<%= name %>.crt">
            <input type="hidden" name="_method" value="delete"/>
            <button type="submit" title="Remove this certificate<%= ' (and the associated private key)' if cert['private_key'] %>!"> 
              <img src="<%= icondir + '/' + iconsize + '/actions/remove.png'%>" alt="delete"/>
            </button>
          </form>
        </td>
        <% if cert['cert']['err'] and not cert['cert']['ok'] %>
          <td colspan="0" class="error">Certificate Error for &ldquo;<code><%= name %>.crt</code>&rdquo;: <code><%= cert['cert']['err'] %></code></td>
        <% else %>
          <td><a title="Click to download the certificate" href="/crypto/ssl/certs/<%= name %>.crt"><code><%= cert['cert']['subject']['CN'] %></code></a></td>
          <td><%= cert['cert']['issuer']['CN'] %></td>
          <% 
            str = ''
            if cert['cert']['subject']['O'] =~ /\S/
              str << cert['cert']['subject']['O']
              str << ", <span style=\"font-style:italic;\">#{cert['cert']['subject']['OU']}</span>" if cert['cert']['subject']['OU'] =~ /\S/
              str << ", " << cert['cert']['subject']['L'] if cert['cert']['subject']['L'] =~ /\S/
              str << "&nbsp;(#{cert['cert']['subject']['ST']})" if cert['cert']['subject']['ST'] =~ /\S/
              str << ", " << cert['cert']['subject']['C'] if cert['cert']['subject']['C'] =~ /\S/
            end
          %>
          <td><%= str %></td>
          <td><%= cert['cert']['key_size'] %></td>
          <% if cert['private_key'] %>
            <% if cert['private_key']['ok'] %>
              <td><%= "<strong>#{i18n.yes}</strong>" %> <small>[<a href="/crypto/ssl/certs/private/<%= name %>.key">download</a>]</small></td>
            <% else %>
              <td class="error"><code><%= html_escape cert['private_key']['err'] %></code></td>
            <% end %>
          <% else %>
            <td><%= i18n.no %></td>
          <% end %>
          <td><%= cert['cert']['is_ca']     ? "<strong>#{i18n.yes}</strong>" : i18n.no %></td>
          <td><%= cert['cert']['is_server'] ? "<strong>#{i18n.yes}</strong>" : i18n.no %></td>
        <% end %>
      </tr>
    <% end %>
  </tbody>
</table>
<h3>Certificate Authority</h3>
<% if objects['ca'] and objects['ca']['err'] %>
  <span class="error">
    Certificate error: <code><%= html_escape objects['ca']['err'] %></code>
  </span>
<% end %>
<% if objects['ca'] and not objects['ca']['err'] %>
  <%
    if objects['ca']['issuer'] == objects['ca']['subject']
      signed_info_html = '<span style="font-style:italic;"><strong>self-signed</strong></span>'
    else
      signed_info_html = 'issued by <em>' + objects['ca']['issuer']['CN'] + '</em>'
    end
  %>
  <table style="display: inline;">
    <caption>CA certificate (<%= signed_info_html %>) [<a title="Click to download the Certificate Authority X509 certificate" href="/crypto/ssl/ca/ca.crt">download</a>]</caption>
    <tbody>
      <tr>
        <th scope="row">Validity</th>
        <td>
          <%= i18n.l(objects['ca']['not_before'].to_date, :full) %>
          -      
          <%= i18n.l(objects['ca']['not_after'].to_date, :full)  %>
        </td>
      </tr>
      <tr>
        <th scope="row">Serial No.</th>
        <td>
          <code>
            <%= objects['ca']['serial'].to_s(16).scan(/..?/).join(':') %>
          </code>
        </td>
      </tr>   
      <tr>
        <th scope="row">X509 Standard version</th>
        <td><%= objects['ca']['version'] %></td>
      </tr>
      <tr>
        <th scope="row">Signature algorithm</th>
        <td><code><%= objects['ca']['signature_algorithm'] %></code></td>
      </tr> 
    </tbody>
  </table>
  <% cadata = objects['ca']['subject'] %>
  <table style="display:inline;">
    <caption style="margin-top:0.5em;">CA details</caption>
    <tbody>
      <tr>
        <th scope="row">Country</th>
        <td>
          <%= countries[cadata['C']] %>
        </td>
      </tr>
      <tr>
        <th scope="row">State/Province</th>
        <td><%= cadata['ST'] %></td>
      </tr>   
      <tr>
        <th scope="row">Location</th>
        <td><%= cadata['L'] %></td>
      </tr>
      <tr>
        <th scope="row">Organization</th>
        <td><%= cadata['O'] %><%= (', <span style="font-style: italic;">' + cadata['OU'] + '</span>') if cadata['OU'] =~ /\S/ %></td>
      </tr> 
      <tr>
        <th scope="row">&ldquo;Common Name&rdquo;</th>     
        <td><code><%= cadata['CN'] %></code></td>
      </tr>
      <tr>
        <th scope="row">E-mail</th>
        <td><code><%= cadata['emailAddress'] %></code></td>
      </tr>
    </tbody>
  </table>
<% end %>

<% if objects['ca'] and not objects['ca']['err'] %>
  <h3>Issue a new certificate</h3>
<% else %>
  <h4>Initialize a new CA</h4>
<% end %>  

<% if objects['ca'] and not objects['ca']['err'] %>
  <form method="POST" action="easy-rsa/cert.html"> 
<% else %>
  <form method="POST" action="easy-rsa/ca.html">
<% end %>

  <table>
    <thead>
      <tr>
        <th>Key Size (bits)</th>
        <th>Expiry (days)</th>
        <th>Country</th>
        <th colspan="2">City (Province/State)</th>
        <th>Organization Name</th>
        <th>Organizational Unit</th>
        <th>E-mail</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td style="text-align:center;">
          <select name="key_size">
            <% OnBoard::Crypto::SSL::KEY_SIZES.each do |ksiz| %>
              <option value="<%= ksiz %>"><%= ksiz %></option>  
            <% end %>
          </select>
        </td>
        <td><input name="days" size="4" value="3650"/></td>
        <td style="text-align:center;">
          <select name="C">
            <% country_codes_by_name.each do |cc| %>
              <option value="<%= cc %>" <%= 'selected' if cc == current_country_code %> title="<%= html_escape countries[cc] %>">
                <%= 
                  html_escape countries[cc][0..18] 
                      # truncate to not mess the page layout
                %> 
              </option> 
            <% end %>
          </select> 
        </td>
        <td><input name="L"  type="text" size="9"/></td>
        <td><input name="ST" type="text" size="2"/></td>
        <td style="text-align:center;">
          <input name="O" type="text" size="12"/></td>
        <td style="text-align:center;">
          <input name="OU" type="text" size="11"/></td>
        <td style="text-align:center;">
          <input name="emailAddress" type="text" size="14"/></td>
      </tr>
    </tbody>
  </table>
  <% if objects['ca'] and not objects['ca']['err'] %>
    <table>
      <thead>
        <tr>
          <th title="A unique identifier, typically the hostname of the subject machine">&ldquo;Common Name&rdquo;</th>
          <th>Type</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><input type="input" name="CN" title="A unique identifier, typically the hostname of the subject machine"/></td>
          <td>
            <select name="type">
              <option value="client">Client</option>
              <option value="server">Server</option>
            </select>
          </td>
        </tr>
      </tbody>
    </table>
  <% end %>
  <button type="submit" style="margin: 0.3em 0.6em;">Create!</button>
</form>

<h3>Import certificate</h3>
<form method="POST" action="/crypto/ssl/certs.html" enctype="multipart/form-data">
  <input type="hidden" name="file_upload" value="yes"/>
  <table>
    <tr>
      <th scope="row">X509 Certificate</th>
      <td><input type="file" name="certificate"/></td>
    </tr>
    <tr>
      <th scope="row">Associated private key (optional)</th>
      <td><input type="file" name="private_key"/></td>
    </tr>
  </table>
  <button type="submit">Upload!</button>
</form>

